include: 
- template: Security/Dependency-Scanning.gitlab-ci.yml
- template: Security/Secret-Detection.gitlab-ci.yml 

stages:
  - build
  - test

backend-build:
  stage: build
  image: openjdk:17-jdk
  script:
    - cd AllocationSystemBackend
    - chmod +x gradlew
    - ./gradlew build
  artifacts:
    paths:
      - AllocationSystemBackend/build/
  rules:
    - changes:
        - AllocationSystemBackend/**

backend-test:
  stage: test
  image: openjdk:17-jdk
  script:
    - cd AllocationSystemBackend
    - chmod +x gradlew
    - ./gradlew test
  rules:
    - changes:
        - AllocationSystemBackend/**

frontend-build:
  stage: build
  image: node:20
  script:
    - cd AllocationSystemFrontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - AllocationSystemFrontend/dist/
  rules:
    - changes:
        - AllocationSystemFrontend/**

frontend-lint:
  stage: test
  image: node:20
  script:
    - cd AllocationSystemFrontend
    - npm ci
    - npm run lint
  rules:
    - changes:
        - AllocationSystemFrontend/**

# Run GitLab dependency scanning for JS/TS deps (frontend) on MRs and default branches
dependency_scanning: 
  stage: test
  variables:
    DS_DISABLE_DIND: "true"
    DS_IMAGE: "registry.gitlab.com/security-products/dependency-scanning:5"
  script: 
    - cd AllocationSystemFrontend
    - /analyzer run 
  rules: 
  # Run on merge requests that touch frontend or root package files 
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    changes: 
      - AllocationSystemFrontend/**
      - package.json
      - package-lock.json 
  # Also run the default branch (development)
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Check for accidentally commited secrets in diffs and default branch 

secret_detection:
  stage: test 
  rules: 
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
